Лекции по сетевым ОС:  
[https://studopedia.ru/3_173600_podrobnoe-opisanie.html](https://studopedia.ru/3_173600_podrobnoe-opisanie.html)
[https://timeweb.com/ru/community/articles/chto-takoe-dhcp-protokol](https://timeweb.com/ru/community/articles/chto-takoe-dhcp-protokol)
[https://neoserver.ru/kak-rabotaet-dns](https://neoserver.ru/kak-rabotaet-dns)

---

```table-of-contents
style: nestedOrderedList
title:# <center>ОГЛАВЛЕНИЕ</center>
```

---

# Общее

Лекций — 4

# Базовые понятия

>[!Note] Термин
>**Каталог** — это информационный ресурс, используемый для хранения информации о каком либо объекте
>**Служба каталогов** — сетевая служба, которая идентифицирует все ресурсы сети и делает их доступными польз. СК работает как главный компонент сетевой ОС
>**Active Directiory** — служба каталогов, поставляемая с MS Win2000 Server. AD содержит каталог, в котором хранится информация о сетевых ресурсах и службы, предоставляющие доступ к этой информации.

**Преимущества Active Directory:**
- упрощённое администрирование;
- масштабируемость;
- поддержка открытых стандартов;
- поддержка стандарт форматов имен;

С помощью Active Directory осуществляется централизованное управление пользователями, группами, общими папками и сет ресурсами, администрирование среды пользователя и ПО средствами групповой поддержки.

Назначение: служба каталогов - инструмент администратора и пользователя....

**Служба каталогов позволяет:**
- обеспечивать защиту информации от вмешательства посторонних лиц в рамках, установленных администратором системы;
- распространять каталог среди других компьютеров в сети;
- проводить репликацию (тиражирование)
- ...

**Функции службы каталогов:**
- Централизация
- Масштабируемость
- Стандартизация
- Расширяемость
- Разделение физической сети
- Безопасность

**Основные задачи Active Directory:**
- Хранить информацию об объектах сети и предоставлять эту информацию пользователям и системным администраторам;
- Позволять пользователям сети обращаться к общим ресурсам, единожды введя имя и пароль;
- Представлять сеть в интуитивно понятном иерархическом виде и позволять централизованно управлять всеми объектами сети;
- Повышать степень информационной безопасности за счёт разграничения административных полномочий обслуживающего персонала и внедрения современных методов зашиты информации;
- Позволять спроектировать единую структуру каталога так. как это необходимо в организации, чтобы обеспечить прозрачное использование информационных ресурсов а рамках компании.

**Преимущества Active Directory:**
- Учетные записи пользователей, групп и машин могут быть организованы в виде контейнеров каталога, называемых организационными подразделениями или просто подразделениями.
- В каталоге Active Directory поддерживается большое число объектов.
- Расширенные возможности администрирования
- Служба тиражирования каталогов позволяет несколько копий учетной информации
- Хранение учетной информации в Active Directory означает что пользователи и группы представлены в виде каталога.
- Централизованный каталог.
- Единая регистрация.
- Делегированное администрирование.
- Интерфейс общего управления.
- Интегрированная безопасность.
- Масштабируемость.

# Основные понятия службы каталогов

**Область действия группы** — это термин, используемый для классификации уровней разрешений используемый для каждой группы безопасности
**Пространство имен** — это такая ограниченная область, в которой может быть распознано данное имя. Распознавание имени заключается в его сопоставлении с некоторым объектом или объемом информации, которому это имя соответствует
**Объект** — это непустой, именованный набор атрибутов, обозначающий нечто конкретное, например пользователя принтер или приложение
**Контейнер** аналогичен объекту в том смысле, что он также имеет атрибуты и принадлежит пространству имен Однако, в отличие от объекта, контейнер не обозначает ничего конкретного: он может содержать группу объектов или другие контейнеры
Термин **дерево** используется для описания иерархии объектов и контейнеров. Как правило, конечными элементами дерева являются объекты. В узлах (точках ветвления) дерева располагаются контейнеры.
**Имя:**
- ***Уникальное имя:*** /O=Internet/DC=COM/DC=Microsoft/CN=Users/CN=James Smith
- ***Относительное имя:*** CN=James Smith
**Контексты имен.** Сервер АО содержит не менее 3х:
- логическую структуру;
- конфигурацию (топологию репликации и соответствующие метаданные),
- один или несколько пользовательских контекстов имен (поддеревья, содержащие объединенные в каталог объекты).
**Домен** — это единая область, которой в пределах обеспечивается безопасность данных в компьютерной сети под управлением ОС Windows
**Дерево доменов** состоит из нескольких доменов, которые имеют общую логическую
структуру и конфигурацию и образуют непрерывное пространство имён. Домены в
дереве связаны между собой доверительными отношениями. Active Directory является
множеством, которому принадлежат одно или нисколько деревьев доменов.
![[Pasted image 20250904191635.png]]

**Доменный лес**
![[Pasted image 20250904191852.png]]

**Организационные единицы** (Organtntional Units, OU) или организационные подразделения (ОП) позволяют разделять домен на зоны административного управления, т. е. создавать единицы административного управления внутри домена.
![[Pasted image 20250904185452.png]]

**Узлом** (сайтом) называется такой элемент сети, который содержит серверы Active Directory. Узел обычно определяется как одна или несколько подсетей, поддерживающих протокол TCP/IP и характеризующихся хорошим качеством связи, которое подразумевает высокую надёжность и скорость передачи данных.

# Компоненты Active Directory
![[Pasted image 20250904185759.png]]

# Сбор и анализ информации
- Для планирования структуры Active Directory — информация о доменной структуре и ее типе, структуре групп пользователей и распределению их по доменам, количестве существующих контроллеров доменов внутри каждого домена.
- Для планирования сайтов Active Directory информация о существующей структуре сайтов, о топологии сети, о каналах связи и их пропускной способности.
- Для планирования переноса текущей структуры сетевых сервисов на платформу Active Directory информация о топологии используемых сетевых сервисов ОНСР, WlNS, DNS
- Для обеспечения возможности резервного восстановления данных во время миграции — схема резервного копирования информации
- Для определения возможной расширяемости решения исследование возможных вариантов изменения схемы при росте организации или ее реорганизации, определение области Active Directory. 
- Для планирования миграции приложений, использующих Active Directory — список приложении, связанных с Active Directory, и возможных ограничений, накладываемых ими на структуру Active Directory, определение механизмов идентификации пользователей.

# План проектирования структуры Active Directory
1. Планирование структуры лесов
2. Планирование доменов для каждого леса
3. Планирование использования сайтов для каждого леса
4. Планирование структуры организационных единиц для каждого домена
5. Планирование реорганизации существующих доменов и их перевод на новую платформу Active Directory
6. Тестирование внедряемых решений и установка стенда

# Архитектура ACTIVE DIRECTORY

## Модель данных
Объект — это отдельный именованный набор атрибутов, которыми представлен сетевой ресурс. Атрибуты объекта являются его характеристиками в каталоге.
![[Pasted image 20250904192102.png]]


![[Pasted image 20250904192054.png]]

## База данных Active Directory
**Структурные объекты БД AD:**
- **Разделы (сегменты):** разделы ActIve Directory называются контекстами именования (NC — Naming Contexts) и содержат следующие сегменты: раздел домена каталога, раздел конфигурации каталога, раздел схемы каталога, раздел глобального каталога, разделы приложений каталога;
- Домены — базовая организационная структура.
- Деревья — несколько доменов объединяются в иерархическую структуру.
- Леса — группа из нескольких деревьев домена.
- Организационные единицы — позволяют делить домен на зоны и делегировать права на них.

**Логическая структура**
![[Pasted image 20250904192045.png]]

**Физическая структура**
![[Pasted image 20250904191415.png]]

Физическое проявление службы Active Directory состоит в наличии отдельного файла данных, расположенного на каждом контроллере домена. Физическая реализация службы Active Directory описывается местоположением контроллеров домена, на которых расположена служба. При реализации службы Active Directory можно добавлять столько контроллеров доменов, сколько необходимо для поддержания служб каталога в данной организации. Имеется пять определенных ролей, которые может играть каждый из контроллеров домена. Они известны как **_роли хозяина операций (operations master roles)._** Еще одна роль, которую может выполнять любой отдельный контроллер домена в домене, связана с глобальным каталогом (GC — Global Catalog). В этом разделе мы рассмотрим хранилище данных службы Active Directory и контроллеры домена, на которых оно расположено.

## Контроллеры доменов и их роли

Контроллер домена — это компьютер-сервер, управляющий доменом и хранящий реплику каталога домена (локальную БД домена). Поскольку в домене может быть несколько контроллеров домена, все они хранят полную копию той части каталога, которая относится к их домену .

Ниже перечислены функции контроллеров доменов .

- Каждый контроллер домена хранит полную копию всей информации Active Directory, относящейся к его домену, а также управляет изменениями этой информации и реплицирует их на остальные контроллеры того же домена.
- Все контроллеры в домене автоматически реплицируют между собой все объекты в домене. Какие-либо изменения, вносимые в Active Directory, на самом деле производятся на одном из контроллеров домена. Затем этот контроллер домена реплицирует изменения на остальные контроллеры в пределах своего домена. Задавая частоту репликации и количество данных, которое Windows будет передавать при каждой репликации, можно регулировать сетевой трафик между контроллерами домена.
- Важные обновления, например отключение учетной записи пользователя, контроллеры домена реплицируют немедленно.
- Active Directory использует репликацию с несколькими хозяевами (multimaster replication), в котором ни один из контроллеров домена не является главным. Все контроллеры равноправны, и каждый из них содержит копию базы данных каталога, в которую разрешается вносить изменения. В короткие периоды времени информация в этих копиях может отличаться до тех пор, пока все контроллеры не синхронизируются друг с другом.
- Наличие в домене нескольких контроллеров обеспечивает отказоустойчивость. Если один из контроллеров домена недоступен, другой будет выполнять все необходимые операции, например записывать изменения в Active Directory.
- Контроллеры домена управляют взаимодействием пользователей и домена, например находят объекты Active Directory и распознают попытки входа в сеть.

Существует две роли хозяина операций, которые могут быть назначены единственному контроллеру домена в лесу (роли, действующие в границах леса):

- **_Хозяин схемы (Schema Master)._** Первый контроллер домена в лесу принимает роль хозяина схемы и отвечает за поддержку и распространение схемы на остальную часть леса. Он поддерживает список всех возможных классов объектов и атрибутов, определяющих объекты, которые находятся в Active Directory. Если схему нужно обновлять или изменять, наличие Schema Master обязательно.
- **_Хозяин именования доменов (Domain Naming Master)._** Протоколирует добавление и удаление доменов в лесу и жизненно необходим для поддержания целостности доменов. Domain Naming Master запрашивается при добавлении к лесу новых доменов. Если Domain Naming Master недоступен, то добавление новых доменов невозможно; однако при необходимости эта роль может быть передана другому контроллеру.

Существует три роли хозяина операций, которые могут быть назначены одному из контроллеров в каждом домене (общедоменные роли).

- **_Хозяин RID (Relative Identifier (RID) Master)._** Отвечает за выделение диапазонов относительных идентификаторов (RID) всем контроллерам в домене. SID в Windows Server 2003 состоит из двух частей. Первая часть — общая для всех объектов в домене; для создания уникального SID к этой части добавляется уникальный RID. Вместе они уникально идентифицируют объект и указывают, где он был создан.
- **_Эмулятор основного контроллера домена (Primary Domain Controller (PDC) Emulator)._** Отвечает за эмуляцию Windows NT 4.0 PDC для клиентских машин, которые еще не переведены на Windows 2000, Windows Server 2003 или Windows XP и на которых не установлен клиент службы каталогов. Одна из основных задач эмулятора PDC — регистрировать устаревшие клиенты. Кроме того, к эмулятору PDC происходит обращение, если аутентификация клиента оказалась неудачной. Это дает возможность эмулятору PDC проверять недавно измененные пароли для устаревших клиентов в домене, прежде чем отклонять запрос на вход.
- **_Хозяин инфраструктуры (Infrastructure Master)._** Регистрирует изменения, вносимые в контролируемые объекты в домене. Обо всех изменениях сначала сообщается Infrastructure Master, и лишь потом они реплицируются на другие контроллеры домена. Infrastructure Master обрабатывает информацию о группах и членстве в них для всех объектов в домене. Еще одна задача Infrastructure Master — передавать информацию об изменениях, внесенных в объекты, в другие домены.

![](https://www.ok-t.ru/studopediaru/baza4/1194418926.files/image010.png)

Рис. 3.4. Принятое по умолчанию распределение ролей хозяина операций в лесе

Роль «Сервер глобального каталога» (GC — Global Catalog) может выполнять любой отдельный контроллер домена в домене — одна из функций сервера, которую можно назначить контроллеру домена . Серверы глобального каталога выполняют две важные задачи. Они дают возможность пользователям входить в сеть и находить объекты в любой части леса. Глобальный каталог содержит подмножество информации из каждого доменного раздела и реплицируется между серверами глобального каталога в домене. Когда пользователь пытается войти в сеть или обратиться к какому-то сетевому ресурсу из любой точки леса, соответствующий запрос разрешается с участием глобального каталога. Другая задача глобального каталога, полезная независимо от того, сколько доменов в вашей сети, — участие в процессе аутентификации при входе пользователя в сеть. Когда пользователь входит в сеть, его имя сначала сверяется с содержимым глобального каталога. Это позволяет входить в сеть с компьютеров в доменах, отличных от того, где хранится нужная пользовательская учетная запись.

## Концепция сайтов

Концепция сайтов используется продуктами семейства Microsoft BackOffice для минимизации трафика в глобальной сети и основывается на том, что ее основу составляет IP-сеть, для которой надо обеспечить наилучшие условия подключений вне зависимости от используемых приложений.

Сайт Windows Server 2003 — это группа контроллеров доменов, которые находятся в единой или нескольких IP-подсетях и связаны скоростными и надежными сетевыми соединениями. Сайты в основном используются для управления трафиком репликации. Контроллеры доменов внутри сайта могут свободно реплицировать изменения в базу данных Active Directory всякий раз, когда происходят такие изменения. Однако контроллеры доменов в разных сайтах сжимают трафик репликации и передают его по определенному расписанию, чтобы уменьшить сетевой трафик.

Сайты не являются частью пространства имен Active Directory. Когда пользователь просматривает логическое пространство имен, компьютеры и пользователи группируются в домены и OU без ссылок на сайты.

Сайты содержат объекты только двух типов [3]:

- Контроллеры доменов в границах сайта.
- Связи сайта (site links), сконфигурированные для соединения данного сайта с остальными. Связь состоит из двух частей: физического соединения между сайтами (обычно WAN-канала) и объекта связи сайта (site link object). Этот объект создается в Active Directory и определяет протокол передачи трафика репликации (IP или SMTP). Объект связи сайта также инициирует выполнение запланированной репликации.

Планирование сайтов и их размещение зависит от физической топологии сети, при этом необходимо учитывать потребность в линиях связи для осуществления межсайтовой репликации по создаваемому расписанию.

Сайт с Active Directory состоит из одной или нескольких подсетей IP, которые могут быть определены администратором и изменены им путем включения новых подсетей.

Деление на сайты не зависит от доменной (логической) структуры, то есть:

- в сайте может быть один домен (либо только его часть) или несколько доменов;
- в домене (или даже в организационном подразделении) может быть несколько сайтов.

Создание сайтов, структура которых отражает физическое расположение контроллеров доменов на площадках компании, может быть реализовано по одному из следующих вариантов:

- структура с одним сайтом (единый сайт, включающий все IP-подсети);
- структура с несколькими сайтами (отдельный сайт для каждой площадки).

Особенностями сайта являются:

- оптимизация трафика тиражирования между сайтами по медленным линиям;
- помощь клиентам быстрее обнаруживать ближайшие к ним контроллеры.

Понятие сайта неразрывно связано с топологией тиражирования. Тиражирование внутри сайта и между сайтами использует различные топологии:

- Внутри сайта — это двунаправленное кольцо. Тиражирование выполняется методом вызова удаленных процедур (Remote Procedure Calls, RPC). Внутри сайта контроллер домена задерживает оповещение о сделанных изменениях на некоторый устанавливаемый промежуток времени.
- Для тиражирования между сайтами применяется RPC или сообщения. Стандартно используется механизм SMTP, однако если в сети есть Microsoft Exchange, то он также может быть задействован для тиражирования Active Directory.

Служба каталогов отслеживает целостность топологии: ни один контроллер домена не может быть исключен из процесса тиражирования, что обеспечивается отдельным контрольным процессом (Knowledge Consistency Checker, KCC), исполняемым на всех контроллерах домена — в случае нарушения топология тиражирования восстанавливается KCC.

Для поиска ближайших ресурсов или контроллеров домена клиенты могут использовать информацию о сайте. Концепция поиска ближайшего ресурса или контроллера домена позволяет сократить трафик в низкоскоростных частях глобальных сетей. В начале процесса входа в сеть клиент получает от контроллера домена имя сайта, к которому принадлежит, имя сайта, к которому относится контроллер домена, а также информацию о том, является ли данный контроллер домена ближайшим к клиенту. Если это не ближайший контроллер, то клиент может обратиться к контроллеру домена в его собственном сайте и в дальнейшем работать с ним как с ближайшим контроллером. Так как на клиенте данная информация сохраняется в реестре, она может быть использована во время следующего входа в сеть.

Для возможности управления сертификатами безопасности при многодоменной инфраструктуре (внедрение методов защиты информации), учитывающей интеграцию с другими платформами, а также для гарантированной идентификации пакетов при проведении межсайтовой репликации в структуре Active Directory планируется и создается архитектура открытых ключей (PKI).

Сервер сертификатов является важной частью архитектуры открытых ключей и позволяет издавать в компании собственные сертификаты для своих пользователей, реализуя такие возможности политик PKI, как проверка подлинности на основе сертификатов, IPSec, защищенная электронная почта и др.

# **ПЛАНИРОВАНИЕ РАЗВЕРТЫВАНИЯ ACTIVE DIRECTORY**

Развертывание службы каталога Active Directory требует планирования и проектирования. Мы приведем краткий обзор процесса планирования, через который необходимо пройти, прежде чем начать развертывание Active Directory. Самый главный вопрос — сколько лесов требуется для сети организации. Затем обсуждается разбиение лесов на домены и планирование доменного пространства имен. При подготовке вариантов развертывания Active Directory необходимо спланировать структуру доменов (корневой домен и дерево доменов), а также пространство имен DNS для возможности создания доменной иерархии.

Кроме того, необходимо выработать подход по размещению объектов в организационных подразделениях, что подразумевает определение механизма разделения ресурсов компании по организационным подразделениям, а также анализ внешних условий, применяемых к их иерархии. После создания структуры организационных единиц для каждого домена необходимо сконфигурировать сайты.

Указанные действия позволяют учесть разветвленную структуру компании при развертывании единой инфраструктуры Active Directory:
- Формирование проектной группы.
- Инициация проекта, согласование плана работ, ролей и ответственности.
- Обследование существующей инфраструктуры:
	- Обследование существующей структуры Active Directory.
	- Обследование инфраструктуры (приложения, использующие Active Directory).
	- Формализация результатов обследования.
- Планирование структуры Active Directory:
	- Анализ требований заказчика к построению инфраструктуры Active Directory.
	- Планирование деревьев (леса) и доменов.
	- Планирование топологии сайтов.
	- Разработка архитектуры PKI.
	- Планирование политики резервного копирования.
	- Планирование системы мониторинга на период опытной эксплуатации.
	- Формализация и разработка технического задания.
- Развертывание тестовой среды, тестирование миграции:
	- Определение перечня приложений, подлежащих тестированию.
	- Определение аппаратной конфигурации тестового стенда.
	- Определение набора ресурсов Active Directory для миграции (для каждого приложения).
	- Развертывание репрезентативной копии боевой среды.
	- Верификация идентичности тестовой среды промышленной среде.
	- Развертывание спроектированной структуры Active Directory в тестовой среде.
	- Проведение тестовой миграции.
	- Деинсталляция копии боевой среды.
	- Верификация корректности проведенной миграции. 
	- Формирование проектной документации (типовая процедура миграции).
- Развертывание структуры Active Directory корневого домена и центрального офиса.
	- Информирование пользователей.
	- Развертывание спроектированной структуры Active Directory.
	- Проведение миграции.
	- Наблюдение в период адаптации.
	- Доработка типовой процедуры миграции по результатам развертывания.
	- Обучение администраторов.
- Тиражирование решения на филиалы организации.
- Доработка и сдача документации.

## **Анализ существующей инфраструктуры**

В первую очередь определяется географическая модель организации, то есть определяются следующие составляющие.
- Локальная модель.
- Региональная модель.
- Национальная модель.
- Международная модель.
- Филиалы.
- Дочерние компании.

На основании данной информации создается карта территориального размещения организации и проводится анализ топологии существующей сети. Для сбора сведений об информационных потоках в организации анализируется текущая модель администрирования и существующие процессы в организации.

Первый шаг в планировании структуры Active Directory — определение лесов и доменов. Более подробная информация о вариантах построения лесов и вариантах определения доменной структуры приведена в следующей лекции.

Самое главное решение, которое необходимо принять на раннем этапе разработки Active Directory, — сколько лесов потребуется. Развертывание единственного леса означает, что будет возможно простое совместное использование ресурсов и доступ к информации в пределах компании. Использование единственного леса для большой корпорации требует высокой степени доверия между разнообразными и, возможно, разъединенными деловыми подразделениями. В конечном счете количество развертываемых лесов зависит от того, что является наиболее важным для компании: легкость совместного использования информации в пределах всех доменов леса или поддержка полностью автономного и изолированного управления частями структуры каталога.

Для более успешного проектирования структуры лесов службы Active Directory необходимо привлечение бизнес-заказчиков, которые являются основными потребителями услуг, обеспечиваемых ИТ-инфраструктурой. Эти задачи касаются вопросов доступности информации, безопасности, простоты управления и практичности. Менеджеры обычно включаются в принятие решений, которые не могут быть изменены сразу после развертывания. Среди этих решений — вопрос о том, сколько лесов и доменов требуется сети и сколько должно быть развернуто доменных пространств имен.

Лес Active Directory предназначен для того, чтобы быть отдельным самодостаточным модулем. Внутри леса должна быть реализована возможность совместно использовать информацию и сотрудничать с другими пользователями из того же самого подразделения. Проектируя самый высокий уровень инфраструктуры Active Directory, необходимо решить, нужно ли развертывать один лес или несколько. **Каждый лес является интегрированным модулем, потому что он включает следующие составляющие:**
- **_Глобальный каталог._** Лес имеет один глобальный каталог (GC). Каталог GC облегчает поиск объектов в любом домене леса и вход на любой домен леса независимо от того, на каком домене зарегистрирована учетная запись пользователя.
- **_Раздел конфигурации каталога._** Все контроллеры домена совместно используют один и тот же раздел конфигурации каталога. Эта информация нужна для оптимизации репликации информации в пределах леса, для хранения приложений и информации Active Directory, поддерживающей приложения, и для совместного использования информации с помощью раздела приложений каталога.
- **_Доверительные отношения._** Все домены в лесу связаны двусторонними транзитивными доверительными отношениями. Не существует никакой опции, позволяющей изменить это.

В то время как служба Active Directory облегчает совместное использование информации, она предписывает множество ограничений, которые требуют, чтобы различные подразделения в компании сотрудничали различными способами .

- **Одна схема.** Все домены в лесу используют одну схему. Это обстоятельство как будто упрощает дело, но оно может быть одной из причин развертывания нескольких лесов в компании. Если одно подразделение решает развертывать приложение, которое изменяет схему, то это оказывает воздействие на все подразделения. Каждая модификация схемы должна быть проверена для гарантии того, что она не находится в противоречии с другими изменениями схемы. Это потребует значительного времени и усилий.
- **Централизованное управление.** Развертывание единственного леса означает, что некоторые компоненты сетевого управления должны быть централизованы. Например, единственная группа, обладающая правом изменять схему, — это группа Schema Admins (администраторы схемы). Единственная группа, обладающая правом добавлять и удалять домены из леса, — это группа Enterprise Admins (администраторы предприятия). Группа Enterprise Admins автоматически добавляется к домену локальной группы Administrators (администраторы) на каждом контроллере домена в лесу.
- **Политика управления изменениями.** Поскольку изменения леса могут затрагивать каждый домен и должны выполняться только централизованно, требуется четкая политика управления изменениями.
- **Доверенные администраторы.** Развертывание одного леса требует определенной степени доверия администраторам всех доменов. Любой администратор, обладающий правами управления контроллером домена, может сделать такие изменения, которые затронут весь лес. Это означает, что все администраторы доменов должны быть высокодоверенными людьми.

Обдумывая вопрос, касающийся количества развертываемых лесов, необходимо оценить каждый из этих факторов для определения потребностей организации, в которой планируется внедрение Active Directory.

## **Проектирование доменной структуры**

Как только вопрос о количестве развертываемых лесов улажен, необходимо определить доменную структуру в пределах каждого из лесов. Первая задача состоит в том, чтобы задокументировать конфигурацию текущих служб каталога и определить, какая часть текущей инфраструктуры может быть модернизирована, а какая должна быть реструктурирована или заменена. Затем определяется необходимое количество доменов и их иерархия.

Домены используются для разделения большого леса на более мелкие компоненты для целей репликации или администрирования. Следующие характеристики домена крайне важны при проектировании Active Directory :

- **_Граница репликации._** Границы домена являются границами репликации для раздела домена каталога и для информации домена, хранящейся в папке Sysvol на всех контроллерах домена. В то время как другие разделы каталога (раздел схемы, конфигурации и GC) реплицируются по всему лесу, раздел каталога домена реплицируется только в пределах одного домена.
- **_Граница доступа к ресурсам._** Границы домена являются также границами для доступа к ресурсам. По умолчанию пользователи одного домена не могут обращаться к ресурсам, расположенным в другом домене, если только им не будут явно даны соответствующие разрешения.
- **_Граница политики безопасности._** Некоторые политики безопасности могут быть установлены только на уровне домена. Эти политики, такие как политика паролей, политика блокировки учетных записей и политика билетов Kerberos, применяются ко всем учетным записям домена.

В то время как в большинстве компаний внедряется модель Active Directory с единым лесом, некоторые крупные компании развертывают несколько доменов в пределах этого леса. Проще всего управлять единственным доменом, он обеспечивает пользователей наименее сложной средой. Однако имеется ряд причин для развертывания нескольких доменов [3].

- **Применение одного домена**

· Упрощение управления пользователями и группами.

· Нет необходимости планировать доверительные отношения.

· Для делегирования прав применяются OU.

- **Применение нескольких доменов**

· Возможность реализации разных политик безопасности.

· Децентрализованное управление.

· Оптимизация трафика.

· Разные пространства имен.

· Необходимо сохранить существующую архитектуру доменов Windows NT.

· Размещение хозяина схемы в отдельный домен.

Простейшая модель Active Directory — единственный домен. Подавляющее большинство сетей во всем мире позволяет использовать единственный домен, поэтому такая модель, хотя и может показаться не столь гибкой, как другие, обычно заслуживает самого тщательного рассмотрения. В сущности, при планировании структуры Active Directory полезно исходить из предположения, что будет использоваться один домен, и пытаться остаться в рамках этой модели.

В модели с единственным доменом все объекты находятся в одной зоне безопасности, поэтому не приходится заниматься планированием доверительных отношений с другими доменами или реализовать кросс-доменные аутентификацию и разрешения. Кроме того, при использовании одного домена гораздо проще обеспечить централизованное управление сетью.

Модель с единственным доменом упрощает управление пользователями и группами, а также реализацию групповых политик. По сути, становится легче выполнять почти все операции по управлению сетью, а значит, требуется меньше усилий на планирование, администрирование и устранение неполадок, что в итоге приведет к сокращению общих затрат.

# Использование нескольких доменов

Хотя однодоменная модель дает существенное преимущество — простоту, иногда приходится использовать несколько доменов, потому что существует много серьезных оснований для такого решения .

- Трафик репликации должен быть ограничен. Раздел каталога домена, который является самым большим и наиболее часто изменяемым разделом каталога, копируется на все контроллеры домена в домене. В некоторых случаях это может вызывать слишком большой трафик репликации между офисами компании (даже если сконфигурировано несколько сайтов).
- Между офисами компании существуют медленные сетевые подключения или в офисах имеется много пользователей. Единственный способ ограничить в этом случае трафик репликации состоит в том, чтобы создать дополнительные домены.
- Любые офисы компании, связь между которыми обеспечивается только простым протоколом передачи почты (SMTP), должны конфигурироваться как отдельные домены. Информация домена не может реплицироваться через связи сайта, использующие протокол SMTP.
- Единственный способ иметь различную политику паролей, политику блокировки учетных записей и политику билетов Kerberos состоит в развертывании отдельных доменов.
- Необходимость ограничивать доступ к ресурсам и иметь административные разрешения.
- В некоторых случаях дополнительные домены создаются потому, что лучший путь перехода для организации состоит в модернизации нескольких уже имеющихся доменов.

Лучше планировать домены так, чтобы все они входили в одно дерево доменов. Так как все домены в одном дереве делят одно пространство имен, административные издержки будут значительно ниже, чем при использовании нескольких деревьев. При создании нескольких доменов определять их границы лучше в соответствии с теми разграничениями внутри компании, вероятность изменения которых меньше всего. Например, создание доменов по территориальному принципу, как правило, надежнее, чем создание доменов в соответствии с иерархией подразделений компании, поскольку изменение организационной структуры более вероятно, чем изменение территориальной.

При использовании модели Active Directory с несколькими доменами выполняются следующие правила:

- в каждом домене требуется хотя бы один контроллер;
- групповая политика и управление доступом действует на уровне домена;
- при создании дочернего домена между родительским и дочерним доменами автоматически устанавливаются двусторонние транзитивные доверительные отношения;
- административные права, действующие между доменами, выдаются только для администраторов предприятия;
- необходимо создавать доверяемые каналы.

**Проектирование корневого домена леса**

Другое важное решение, которое целесообразно принять при планировании развертывания службы Active Directory: необходимость развернуть назначенный корневой домен (называемый также пустым корнем). Назначенный корневой домен (dedicated root domain) — это домен, который выполняет функции корневого домена леса. В этом домене нет никаких учетных записей пользователей или ресурсов, за исключением тех, которые нужны для управления лесом.

Для большинства компаний, развертывающих несколько доменов, настоятельно рекомендуется иметь назначенный корневой домен. Корневой домен — это критический домен в структуре Active Directory, содержащий административные группы уровня леса (группы Enterprise Admins и Schema Admins) и хозяев операций уровня леса (хозяина именования доменов и хозяина схемы). Кроме того, корневой домен должен быть всегда доступен, когда пользователи входят на другие домены, не являющиеся их домашними доменами, или когда пользователи обращаются к ресурсам, расположенным в других доменах. Корневой домен нельзя заменять, если он разрушен, его нельзя восстановить — необходимо заново построить весь лес.

Дополнительные задачи при проектировании домена:

- планирование DNS;
- планирование WINS;
- планирование инфраструктуры сети и маршрутизации;
- планирование подключения к Интернету;
- планирование стратегии удаленного доступа.

В данной лекции приведен план-график развертывания Active Directory, который без детализации выглядит следующим образом:

- Формирование проектной группы.
- Инициация проекта, согласование плана работ, ролей и ответственности.
- Обследование существующей инфраструктуры.
- Планирование структуры Active Directory.
- Развертывание тестовой среды, тестирование миграции.
- Развертывание структуры Active Directory корневого домена в центральном офисе.
- Тиражирование решения на филиалы организации.
- Доработка и сдача документации.

При анализе существующей инфраструктуры определяется в первую очередь географическая модель организации, на основании чего создается карта территориального размещения организации и проводится анализ топологии существующей сети.

Первый шаг в планировании структуры Active Directory — определение лесов и доменов.

Самое главное решение, которое необходимо принять на раннем этапе разработки Active Directory, — сколько лесов потребуется. Развертывание единственного леса означает, что будет возможно простое совместное использование ресурсов и доступ к информации в пределах компании.

Каждый лес является интегрированным модулем, потому что он включает следующие составляющие:

- Глобальный каталог.
- Раздел конфигурации каталога.
- Доверительные отношения.

В то время как служба Active Directory облегчает совместное использование информации, она предписывает множество ограничений, которые требуют, чтобы различные подразделения в компании сотрудничали различными способами:

- Одна схема.
- Централизованное управление.
- Политика управления изменениями.
- Доверенные администраторы.

Как только вопрос о количестве развертываемых лесов улажен, необходимо определить доменную структуру в пределах каждого из лесов.

Домены используются для разделения большого леса на более мелкие компоненты для целей репликации или администрирования. Следующие характеристики домена крайне важны при проектировании Active Directory:

- граница репликации;
- граница доступа к ресурсам;
- граница политики безопасности.

В то время как в большинстве компаний внедряется модель Active Directory с единым лесом, некоторые крупные компании развертывают несколько доменов в пределах этого леса. Проще всего управлять единственным доменом, он обеспечивает пользователей наименее сложной средой. Однако имеется ряд причин для развертывания нескольких доменов.

- Применение одного домена:
	- упрощение управления пользователями и группами;
	- нет необходимости планировать доверительные отношения;
	- для делегирования прав применяются OU.
- Применение нескольких доменов:
	- возможность реализации разных политик безопасности;
	- децентрализованное управление;
	- оптимизация трафика;
	- разные пространства имен;
	- необходимо сохранить существующую архитектуру доменов Windows NT;
	- размещение хозяина схемы в отдельный домен.

# DHCP-протокол

## Способы выдачи IP-адресов

IP - Internet Protocol. IPv4 & IPv6
Способы получения:
- **статический** — IP-адрес настраивается вручную;
- **динамический** — IP-адрес получается устройством автоматически, устанавливается временно (опционально);

## Протокол DHCP и динамический IP

**DHCP (Dynamic Host Configuration Protocol)** — сетевой протокол для динамической выдачи IP-адресов, переводится как «_протокол динамической настройки узла_».
**Сетевой протокол** это набор правил и последовательных действий. исходя из них, устройства, которые находятся в сети, соединяются и обмениваются данными между собой.

**DHCP работает по модели «клиент-сервер»:**
**Клиент** — это устройство, которому надо получить IP-адрес для работы в сети
**Сервер** — это устройство. которое раздает IP-адреса клиентам и следит за тем. чтобы два клиента не получили одинаковый IP-адрес

Сервер и клиент обмениваются сообщениями по принципу «запрос-ответ». Взаимодействие состоит из 4 этапов и сокращенно называется «**DORA**». По одной букве на каждый этап:
1. Поиск – **D**iscover.
2. Предложение – **O**ffer.
3. Запрос – **R**equest.
4. Подтверждение – **A**cknowledgement (ACK).

## Взаимодействие DНСР-сервера и клиента
![[Pasted image 20250904202213.png]]
## Поиск (Discover): Клиент → Сервер

На этом этапе клиенту главное найти и узнать, где находится сервер. 

Мы включили компьютер, который находится в сети. Еще в этой же сети работает DHCP. В данном случае наш компьютер – это клиент, а DHCP – сервер. Теперь нашему устройству необходимо получить IP-адрес и другую необходимую информацию о сети, например шлюз, адреса DNS и маску подсети. Поэтому клиент начинает поиски сервера и посылает сообщение «DHCPDISCOVER» на компьютеры внутри этого сегмента сети. 

Такое сообщение называется широковещательным (broadcast) – это значит, что поток данных от клиента получат все устройства внутри его сети. Ответить на такое сообщение смогут только DHCP-серверы.

![[Pasted image 20250904202305.png]]
<center><i>Запрос клиента получат все участники сети, но ответит только сервер</i></center>


### Предложение (Offer): Сервер → Клиент

DHCP-сервер получает сообщение от клиента, после чего выбирает свободный IP-адрес из числа доступных и отправляет его в ответном сообщении «DHCPOFFER». 

Как правило, IP-адрес закрепляется за клиентом на определенное время, поэтому может меняться между сеансами работы в сети. 

Если клиенту ответили несколько серверов, он выберет какой-то один и получит от него IP-адрес с настройками.

### Запрос (Request): Клиент → Сервер

Клиент получил IP-адрес и отправляет серверу ответное сообщение: «DHCPREQUEST». В нем он еще раз прописывает полученный адрес и тем самым подтверждает, что будет использовать его.

Ответное сообщение с IP-адресом получают все DHCP-серверы в сети, если их несколько. Это необходимо для того, чтобы каждый сервер знал, что этот адрес занят, и не предлагал его другим клиентам. 

Только один сервер продолжает взаимодействие с клиентом. Это тот, который предложил выбранный клиентом IP-адрес.

### Подтверждение (ACK): Сервер → Клиент

Сервер отправляет сообщение «DHCPACK» и тем самым закрепляет IP-адрес за клиентом. В сообщении содержится сам адрес, срок его использования и дополнительные настройки сети. Клиент проверяет эти настройки, применяет полученную конфигурацию и получает доступ к сети. 

В общем виде весь процесс взаимодействия выглядит так:

– (Клиент) Кто тут сервер? Мне надо получить IP-адрес: «DHCPDISCOVER».

– (Сервер) Я сервер, предлагаю тебе использовать вот этот IP: «DHCPOFFER».

– (Клиент) Хорошо, я буду использовать этот IP, что ты мне отправил: «DHCPREQUEST».

– (Сервер) Вот и договорились. Приятной работы в сети: «DHCPACK».

### Другие варианты сообщений

- **«DHCPINFORM»** – так клиент запрашивает локальные настройки сети. В ответ на это сообщение сервер посылает запрашиваемую конфигурацию.
    
- **«DHCPNAK»** – так сервер отказывает клиенту пользоваться IP-адресом.
    
- **«DHCPRELEASE»** – так клиент сообщает, что отключается от сети и освобождает свой IP-адрес. После этого сервер снова добавляет этот адрес в список доступных.

## Длительность использования IP-адреса

Время, на которое клиент получает IP-адрес от сервера, называется «срок аренды» (lease time). Он может составлять несколько минут, часов и даже суток. Когда срок аренды заканчивается, адрес освобождается, и сервер может отдать его другому клиенту. 

Клиент может продлить аренду и использовать IP-адрес дальше. Для этого он ждет, пока пройдет половина срока, который изначально назначил сервер. После этого клиент посылает серверу сообщение «DHCPREQUEST», в котором указывает свой текущий IP-адрес. В ответном сообщении «DHCPACK» сервер запускает срок аренды заново. Получилась укороченная схема взаимодействия «клиент-сервер» из двух последних этапов (запрос → подтверждение).

Если сервер молчит и не отправляет подтверждение «DHCPACK», то клиент пробует отправить повторный запрос «DHCPREQUEST», когда пройдет половина от того времени, что осталось сейчас. И так до тех пор, пока не пройдет ⅞ времени всей аренды. После этого клиент начнет отправлять широковещательные запросы на свою сеть и ждать ответа от другого сервера.

Перед тем как завершить работу и отключиться от сети, клиент автоматически отправит серверу сообщение «DHCPRELEASE». Это значит, что IP-адрес свободен и сервер может передать его другому компьютеру.

## Способы раздачи IP-адресов в DHCP

DHCP-сервер может назначать IP-адреса тремя способами:

- фиксированным (ручным),
    
- автоматически,
    
- динамически.
    

**Фиксированный** – в этом случае происходит настройка DHCP сервера, в ходе которой администратор вручную прописывает соответствие между каждым MAC-адресом и IP-адресом. Таким образом, за каждым устройством закрепляется свой адрес, который будет выдавать сервер. 

Это удобно в рамках небольшой сети, когда известны MAC-адреса всех компьютеров.

MAC-адрес или физический адрес – это цифровой адрес устройства, который закреплен за сетевой картой «с завода». Благодаря ему провайдер знает, на какой компьютер направлять интернет-трафик.

**Автоматический** – при таком способе каждое устройство автоматически получает IP-адрес, который не будет меняться. DHCP-сервер выдает адрес в бессрочную аренду, пока клиент от него не откажется. 

**Динамический** – DHCP-сервер выдает клиенту любой адрес из диапазона свободных. Эти адреса не закрепляются за конкретными устройствами. 

Динамическим способом раздают IP-адреса, когда состав пользователей и их количество в сети постоянно меняется, например при использовании Wi-Fi в кафе. В этом случае кафе покупает определенное количество IP-адресов и выдает посетителям, которые подключаются к сети.

## Связь DHCP и клиента в разных подсетях

Обычно сеть дополнительно разделяют на подсети. Это помогает повысить производительность и обеспечить безопасность. Производительность повышается за счет того, что таким образом равномерно распределяется широковещательный трафик. 

DHCP-сервер и клиент могут оказаться в разных подсетях, разделенных одним или несколькими маршрутизаторами. Как правило, маршрутизаторы не пропускают широковещательный трафик.

Вспомним, что первое сообщение, которое отправляет клиент, чтобы найти сервер («DHCPDISCOVER»), – широковещательное. Следовательно, клиент и сервер из разных подсетей не смогут просто так взаимодействовать. 

Эту проблему решают с помощью ретрансляции или DHCP relay. С помощью этой настройки маршрутизаторы смогут передавать только широковещательный трафик, который относится к протоколу DHCP.

Таким образом, если маршрутизатор может работать в режиме DHCP relay, то у него получится передать первый запрос клиента «DHCPDISCOVER» серверу в другой подсети. В этом случае взаимодействию «клиент-сервер» ничего не помешает.

# DNS

## **Что такое** **DNS**

DNS (domain name system) - это система, обеспечивающая работу привычных нам доменных имен сайтов. Связь между устройствами в сети Интернет осуществляется по IP адресам, например: "192.64.147.209". Однако, запомнить IP адреса сложно, поэтому были придуманы удобные для человека доменные имена, например: "google.com".

Компьютер / сервер не хранит таблицу соответствия доменов и их IP адресов. Точнее, не хранит всю таблицу, а временно запоминает данные для часто используемых доменов. Когда в браузере вводится домен сайта, компьютер автоматически узнает его IP адрес, и отправляет по нему запрос. Этот процесс называется «разрешение адреса домена» (domain resolving).

## **Как работает** **DNS**

Система доменных имен состоит из следующих компонентов:

**Иерархическая структура доменных имен:**

- **Доменные зоны верхнего уровня (первого уровня**) – например: "ru", "com", или "org". Они включают в себя все доменные имена, входящие в эту зону. В любую доменную зону может входить неограниченное количество доменов.
- **Доменные имена (доменные зоны второго уровня)** – например: "google.com" или "yandex.ru". Т.к. система доменных имен является иерархичной, то "yandex.ru" можно также назвать поддоменом вышестоящей зоны "ru". Поэтому, правильнее указывать именно уровень домена. Однако, на практике, доменную зону любого уровня называют просто «доменом».
- **Поддомены (доменные зоны третьего уровня)** – например: "api.google.com" или "mail.yandex.ru". Могут быть доменные зоны 4, 5 уровней и так далее.

**DNS сервер или NS (name server) сервер** – поддерживает (обслуживает) доменные зоны, которые ему делегированы. Он непосредственно хранит данные о ресурсных записях для зоны. Например, что сервер, на котором находится сайт "example.ru", имеет IP адрес "1.1.1.1". DNS сервер отвечает на все запросы, касательной этих доменных зон. Если ему приходит запрос о домене, который ему не делегирован, то он спрашивает ответ у других DNS серверов.

**DNS записи (ресурсные записи)** – это набор записей о доменной зоне на NS сервере, которые хранят данные необходимые для работы DNS. На основании данных в этих записях, DNS сервер отвечает на запросы по домену. Список записей, и их значение, вы можете найти ниже. 

**Корневые DNS сервера** (на данный момент их 13 во всем мире) хранят данные о том, какие DNS сервера обслуживают зоны верхнего уровня.

**DNS сервера доменных зон верхнего уровня** - хранят информацию, какие NS сервера обслуживают тот или иной домен.


![[Pasted image 20250904202822.png]]
Для того, чтобы узнать IP адрес, домена компьютер/сервер обращается к DNS-серверу, который указан у него в сетевых настройках. Обычно, это DNS сервер Интернет провайдера. DNS сервер проверяет делегирован домен ему или нет. Если да, то сразу отвечает на запрос. Если нет, то запрашивает информацию о DNS сервере, обслуживающем этот домен, у корневого сервера, и затем у сервера доменных зон верхнего уровня. После этого, непосредственно делает запрос на NS сервер, обслуживающий этот домен, и транслирует ответ вашему компьютеру/серверу.

