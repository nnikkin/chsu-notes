На эффективность применения кэш-памяти влияют следующие моменты:
- **Емкость кэш-памяти**. Выбор емкости кэш-памяти - это определенный компромисс. Т. к., с одной стороны, кэш-память должна быть достаточно мала, чтобы ее стоимость не была высокой. С другой стороны, она должна быть достаточно большой, чтобы среднее время доступа к системе определялось временем доступа к кэш-памяти. Для большинства задач, близкой к оптимальной является кэш-память от 1 до 512 Кб

- **Размер строки**. Когда в кэш-память помещается строка, вместе с требуемым словом попадает и соседнее. По мере увеличения размера строки вероятность промахов сначала падает, т. к. в кэш попадают данные, которые потребуются в ближайшее время. Однако, когда размер строки становится излишне большим, вероятность промахов начинает расти, т. к. большие размеры строки уменьшают общее количество строк, следовательно появляется необходимость частой их замены. По мере увеличения размера строки каждое дополнительное слово оказывается дальше от запрошенного, поэтому оно менее вероятно понадобится в ближайшее время. Наиболее близким к оптимальному является размер строки, равный 4-8 адресуемым единицам. На практике размер строки обычно выбирают равным ширине шины данных между кэшем и основной памятью.

- **Способ отображения основной памяти на кэш-памяти**. Способ отображения должен отвечать 3 требованиям:
	- обеспечивать быструю проверку кэш-памяти на наличие в ней копии блока ОП.
	- обеспечивать быстрое преобразование адреса блока основной памяти в адрес строки кэша
	- Требование реализовывать п.1-2 наиболее экономными средствами
    
Рассмотрим систему, состоящую из основной памяти емкостью 256 килослов (Кслов) и кэш-памяти емкостью 2 Кслова. Для адресации каждого слова основной памяти необходим 18-разрядный адрес. ОП разбивается на блоки по 16 слов. Всего блоков - 214=16384 блока. При такой организации 18-разрядный адрес делится на 2 части: младшие 4 разряда - это адрес слова в пределах блока, а старшие 14 разрядов - это номер блока. В свою очередь, для адресации любого слова в кэш-памяти требуется 11-разрядный адрес. Кэш-память разбита на строки, всего их 27=128 строк. Тогда 11-разрядный адрес слова делится на 2 части: 4 младших разряда - адрес слова в строке, и 7 старших разрядов - это номер или адрес строки в кэш-памяти. Поэтому остается преобразовать 14 разрядный адрес блока основной памяти в 7-разрядный адрес строки кэша.  
Известно 3 способа отображения основной памяти на кэш:
1. **Прямое отображение**. Адрес строки и кэш-памяти, на которую может быть отражен блок j основной памяти, однозначно определяется выражением i=jmodm, где m - общее число строк в кэше, i принимает значения от 0 до 127, j принимает значения от 0 до 16383. ОП условно представлена в виде двумерного массива блоков, количество рядов равно количеству строк в кэш-памяти. В каждом ряду последовательно перечислены блоки, переадресуемые на одну и ту же строку в кэше. 14-разрядный адрес блока основной памяти разбивается на 2 поля. Логика кэш-памяти интерпретирует эти 14 бит, как 7-разрядный тег и 7-разрядное поле строки. Поле тег определяет, какой блок будет отображен. Основной недостаток: жесткое закрепление за определенными блоками основной памяти одной строки в кэше. Поэтому, если программа будет поочередно обращаться к разным блокам из одной строки, то будет постоянно происходить обновление строки кэша и вероятность попадания будет низкой.
![[Pasted image 20250309172002.png]]
2. **Полностью ассоциативное отображение**. Позволяет загрузить любой блок основной памяти в любую строку. В адресе основной памяти выделяется 2 поля: поле тега и поле слова. Поле тега совпадет с адресом блока основной памяти. Для проверки наличия копии блока в кэше логика управления кэш-памятью должна одновременно проверить теги всех строк на совпадение с полем тега адреса. Этому требованию наилучшим образом соответствует ассоциативная память, т. е. тег хранится в ассоциативной памяти тега в кэше. Недостаток - необходимость использования дорогостоящей ассоциативной памяти.  
        [![Полностью ассоциативное отображение](https://github.com/chsu-SE-2022/markelov_notes/raw/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_03.%20%D0%9F%D0%BE%D0%BB%D0%BD%D0%BE%D1%81%D1%82%D1%8C%D1%8E%20%D0%B0%D1%81%D1%81%D0%BE%D1%86%D0%B8%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5%20%D0%BE%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5.png)](https://github.com/chsu-SE-2022/markelov_notes/blob/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_03.%20%D0%9F%D0%BE%D0%BB%D0%BD%D0%BE%D1%81%D1%82%D1%8C%D1%8E%20%D0%B0%D1%81%D1%81%D0%BE%D1%86%D0%B8%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5%20%D0%BE%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5.png)
3. **Частично-ассоциативное отображение**. Делится на 2 части.
- **Часть 1 - множественно-ассоциативное отображение**. Кэш-память разбивается на v модулей, каждый из которых содержит k слов. На строки, входящие в i-тый модуль, могут быть отображены только определенные блоки основной памяти в соответствии с соотношением i=jmodv. j - это адрес блока основной памяти. Размещение блока по строкам модуля произвольное, и для поиска нужной строки в пределах модуля используется ассоциативный принцип. Память в данных кэша разбита на 32 модуля по 4 строки в каждом. Память тегов содержит 32 ячейки, в каждой хранится по 4 тега. Адрес блока ОП делится на 2 части: 9-разрядное поле тега, которое содержит порядковый номер блока, и 5-разрядное поле номера модуля, который однозначно указывает на 1 из модулей кэш-памяти и позволяет определить номера блоков ОП, которые можно отображать на этот модуль. Такими являются блоки ОП, которые при делении на 32 дают в остатке число, совпадающее с номером данного модуля. Именно этот способ наиболее широко распространен в современных микропроцессорах. [![Множественно-ассоциативное отображение](https://github.com/chsu-SE-2022/markelov_notes/raw/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_04.%20%D0%9C%D0%BD%D0%BE%D0%B6%D0%B5%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE-%D0%B0%D1%81%D1%81%D0%BE%D1%86%D0%B8%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5%20%D0%BE%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5.png)](https://github.com/chsu-SE-2022/markelov_notes/blob/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_04.%20%D0%9C%D0%BD%D0%BE%D0%B6%D0%B5%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE-%D0%B0%D1%81%D1%81%D0%BE%D1%86%D0%B8%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5%20%D0%BE%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5.png)
- **Часть 2 - отображение секторов**. Основная память разбивается на секторы, состоящие из фиксированного числа последовательных блоков. Кэш-память также разбивается на секторы, содержащие такое же количество строк. Отображение сектора на кэш-память осуществляется ассоциативно, т. е. любой сектор из ОП может быть помещен в любой сектор кэша. ОП содержит 1024 сектора, каждый состоит из 16 блоков по 16 слов в каждом. В 14-разрядном адресе блока основной памяти старшие 10 разрядов - это номер сектора, младшие 4 - номер блока внутри сектора. Кэш-память состоит из 8 секторов и 7-разрядного адреса строки в кэше, где 3 старших разряда - это адрес сектора, а 4 младших разряда - номер блока внутри сектора. Задача преобразования адресов сводится к переходу от 10-разрядного номера сектора ОП к 3-разрядному номеру сектора кэша. Это осуществляется с помощью ассоциативной памяти с тегом по 8 слов. Каждая ячейка памяти тегов содержит 13 разрядов. 10 старших разрядов хранят тег - номер сектора ОП, 3 младших - номер сектора кэша. Для проверки наличия копии сектора в кэше производится ассоциативный поиск по 10 старшим разрядам памяти тега. Т. к. размер сектора большой, то копируется только требуемый блок. Для этого к каждой строке кэша добавляется 1 бит информации (бит достоверности), показывающий, относится ли данный блок к текущему сектору или в нем осталась информация из другого сектора.  
            [![Отображение секторов](https://github.com/chsu-SE-2022/markelov_notes/raw/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_05.%20%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%BE%D0%B2.png)](https://github.com/chsu-SE-2022/markelov_notes/blob/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/06_05.%20%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D0%BE%D0%B2.png)
- **Алгоритм замещения информации в заполненной кэш-памяти**. Т. к. при прямом отображении каждому блоку ОП соответствует только одна определенная строка кэша, и никакой иной выбор удаляемой при замещении строки невозможен, то нет и алгоритмов замещения. При полностью и частично ассоциативных способах требуется алгоритм замещения удаляемой из кэша строки.
    
    1. Наиболее эффективным считается алгоритм замещения на основе наиболее давнего использования, т. е. удаляется строка, к которой больше всего не было обращений.
    2. Алгоритм, который работает по принципу "первый вошел - первый вышел".
    3. Алгоритм замещения наименее часто использующейся строки. Здесь используется счетчик обращений для каждой строки
    4. Алгоритм произвольного выбора строки для замещения
- **Алгоритм согласования содержимого основной и кэш-памяти**. Т. к. многие устройства ввода-вывода могут напрямую обмениваться информацией с ОП, то возникает ситуация, когда содержимое строки кэша не совпадает с содержимым блока основной памяти. В результате на УВВ может быть выдана из ОП устаревшая информация о процессах, а процессор может использовать старое содержимое кэш-памяти вместо новых данных, загруженных в ОП из УВВ. Для разрешения конфликтной ситуации, когда процессор осуществляет запись, используют 2 алгоритма обновления основной памяти:
    
    1. **Метод сквозной записи**. Прежде всего обновляется слово, хранящееся в основной памяти. Если в кэше есть копия этого слова, то она тоже обновляется
    2. **Метод обратной записи**. Слово заносится только в кэш-память. Если в соответствующей строки в кэш-памяти нет, то нужный блок пересылается из ОП, после чего запись все равно выполняется, только в кэш-памяти. И уже при замещении строки ее предварительно пересылают в соответствующее место основной памяти. В ситуации, когда в ОП из УВВ, минуя процессор доносится новая информация, используют 2 способа:
        1. Система строится так, чтобы любой ввод информации в память автоматически сопровождался соответствующими изменениями в кэше.
        2. Прямой доступ к памяти допускается только через кэш
- **Число уровней кэш-памяти**. Встроенная кэш-память строится на общем кристалле с процессором и является наиболее эффективной и быстродействующей. Для увеличения общей емкости кэш-памяти второй и последующие уровни вставляют между внутренней кэш-памятью и основной


---
## Структура 32-разрядного микропроцессора


[![Структура 32-разрядного процессора](https://github.com/chsu-SE-2022/markelov_notes/raw/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/07_01.%20%D0%A1%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%2032-%D1%80%D0%B0%D0%B7%D1%80%D1%8F%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D1%80%D0%B0.png)](https://github.com/chsu-SE-2022/markelov_notes/blob/main/3%20%D0%BA%D1%83%D1%80%D1%81/%D0%9E%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%AD%D0%92%D0%9C%20%D0%B8%20%D0%B2%D1%8B%D1%87%D0%B8%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC/Pictures/07_01.%20%D0%A1%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%2032-%D1%80%D0%B0%D0%B7%D1%80%D1%8F%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D1%80%D0%B0.png)

- **Процессор чисел с фиксированной точкой**: содержит 32-разрядное АЛУ и 32-разрядный блок регистров общего назначения
    - **АЛУ** предназначено для обработки двоичных чисел длиной в 1, 2 или 4 байта без знака или со знаком, а также двоично-десятичных чисел, не превышающих 99. Двоичные числа со знаком представляются в дополнительном коде
    - **Блок из 8 регистров общего назначения**, часть из которых допускает 16- и 8-разрядное обращение
- **Процессор чисел с плавающей точкой FPU**: состоит из 80-разрядного АЛУ и 80-разрядного блока регистров общего назначения. Используется для обработки чисел с плавающей точкой, целых чисел со знаком длиной 8 байт и двоично-десятичных чисел, начиная со 100
- **Блок управления памятью** состоит из 2 основных блоков:
    - **Блок сегментации** (блок сегментного преобразования адреса)
    - **Блок страничного преобразования адреса**, в состав которого входит блок ассоциативной трансляции страничного адреса TLB
- **Кэш-память**: находится между регистрами процессора и основной памятью. Используется для хранения наиболее часто используемой информации
- **Блок управления**: в состав блока управления входят:
    - **Устройство управления**, которое под действием кода команды вырабатывает набор управляющих сигналов, поступающих на разные узлы процессора и на блок интерфейса внешней шины
    - **Управление защитой** - обеспечивает аппаратную защиту программ и данных по привилегиям
    - **Управление предвыборкой** - реализует опережающее заполнение буфера команд. Буфер команд имеет емкость 32 байта и заполняется командами из следующих ячеек памяти команд по мере своего освобождения. Этим обеспечивается ускорение обработки микропроцессора следующей командой
- **Блок интерфейса внешней шины** - осуществляет электрическое согласование параметров внутренней магистрали с сигналами внешней магистрали, формирование необходимых сигналов на внешнюю магистраль и прием сигналов извне.
- **Внешняя магистраль** - состоит из 3 шин:
    - **Шина данных** - 32 разряда
    - **Шина адреса** - передается 32-разрядный адрес по 34-разрядной шине адреса. A31...A2+(B3,B2,B1,B0). Чтобы с минимальными потерями согласовать 32-разрядную шину данных с передачей данных меньшей разрядности, младшие разряды адреса A0 и A1 передаются в дешифрованном виде. Они показывают, какие байты из 32-разрядной шины данных в данный момент востребованы: 1-ый байт, 2 младших байта, 2 старших байта или все 32
    - **Шина управления** - 32 разряда. Передает сигналы записи и чтения содержимого ОП из внешних устройств, сигналы запросов прерываний и сигналы прямого доступа к памяти

## Типы чисел 32-разрядного процессора

| Тип                      | Размер, байт                      | Диапазон                       | Обработка |
| ------------------------ | --------------------------------- | ------------------------------ | --------- |
| Целые без знака          | 1                                 | 0...255                        | АЛУ ФТ    |
|                          | 2                                 | 0...65535                      | АЛУ ФТ    |
|                          | 4                                 | 0...$4.3∗10^9$                 | АЛУ ФТ    |
| Целые со знаком          | 1                                 | -128...+127                    | АЛУ ФТ    |
|                          | 2                                 | -32768...+32767                | АЛУ ФТ    |
|                          | 4                                 | $−2.1∗10^9$...$2.1∗10^9$       | АЛУ ФТ    |
|                          | 8                                 | $-9.1∗10^{18}$...$9.1∗10^{18}$ | FPU       |
| С плавающей точкой       | 4 (1+8+23), знак-порядок-мантисса | ±3.37∗$10^35$                  | FPU       |
|                          | 8 (1+11+52)                       | ±1.67∗$10^308$                 | FPU       |
|                          | 10 (1+15+64)                      | ±1.1∗$10^4932$                 | FPU       |
| Двоично-десятичные числа | 1 распакованный                   | 0...9                          | АЛУ ФТ    |
|                          | 1 упакованный                     | 0...9                          | АЛУ ФТ    |
|                          | 10 упакованных                    | 0...9...9 (18 цифр)            | FPU       |
